<% layout('/layout/boilerplate') %>

<section class="listing-details-section container my-5">
  <div class="row gy-4">

    <!-- üè° Left Column: Listing Details -->
    <div class="col-lg-8">
      <div class="listing-details-card shadow-sm p-4 bg-white rounded-3">

        <!-- üñºÔ∏è Image -->
        <div class="image-container text-center mb-4">
          <img src="<%= listing.image?.url || 'https://via.placeholder.com/800x400' %>"
               alt="<%= listing.title %>"
               class="img-fluid rounded-3"
               style="max-height: 450px; object-fit: cover; width: 100%;">
        </div>

        <!-- üìÑ Listing Details -->
        <div class="details-content">
          <h2 class="fw-bold text-danger mb-2"><%= listing.title %></h2>
          <p class="text-muted mb-2">
            <i class="fa-solid fa-location-dot me-1"></i>
            <%= listing.location %>, <%= listing.country %>
          </p>
          <p class="h5 mb-3 text-dark">‚Çπ<%= listing.price.toLocaleString("en-IN") %> / night</p>
          <p class="description mb-4"><%= listing.description %></p>

          <!-- ‚úèÔ∏è Edit/Delete Buttons -->
          <% if (currentUser && listing.owner && currentUser._id.toString() === listing.owner._id.toString()) { %>
            <div class="action-buttons mb-4">
              <a href="/listings/<%= listing._id %>/edit" class="btn btn-outline-primary me-2">
                <i class="fa-solid fa-pen-to-square"></i> Edit
              </a>
              <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" style="display:inline;">
                <button type="submit" class="btn btn-outline-danger">
                  <i class="fa-solid fa-trash"></i> Delete
                </button>
              </form>
            </div>
          <% } %>

          <!-- ‚ù§Ô∏è Favorite Button -->
          <% if (currentUser) { %>
            <% const isFavorite = currentUser.favorites && currentUser.favorites.some(fav => fav.toString() === listing._id.toString()); %>
            <form action="/favorites/<%= listing._id %>/<%= isFavorite ? 'remove' : 'add' %>" method="POST" style="display:inline;">
              <button class="btn <%= isFavorite ? 'btn-danger' : 'btn-outline-danger' %> rounded-pill">
                <i class="fa-solid fa-heart me-1"></i>
                <%= isFavorite ? 'Unfavorite' : 'Favorite' %>
              </button>
            </form>
          <% } %>

          <!-- üí¨ Review Section -->
          <div class="reviews-section mt-5">
            <h3 class="mb-3 text-dark">Leave a Review</h3>

            <% if (currentUser) { %>
              <form action="/listings/<%= listing._id %>/reviews" method="POST" class="review-form mb-5">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-semibold">Your Name</label>
                    <input type="text" class="form-control" value="<%= currentUser.username %>" readonly />
                  </div>

                  <div class="col-md-6">
                    <label for="rating" class="form-label fw-semibold">Rating</label>
                    <select name="review[rating]" id="rating" class="form-select" required>
                      <option value="" disabled selected>Choose rating</option>
                      <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ (5)</option>
                      <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ (4)</option>
                      <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ (3)</option>
                      <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ (2)</option>
                      <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ (1)</option>
                    </select>
                  </div>

                  <div class="col-12">
                    <label for="comment" class="form-label fw-semibold">Comment</label>
                    <textarea name="review[comment]" id="comment" rows="3" class="form-control" placeholder="Write your review..." required></textarea>
                  </div>
                </div>

                <div class="mt-3">
                  <button type="submit" class="btn btn-danger">
                    <i class="fa-solid fa-paper-plane"></i> Submit Review
                  </button>
                </div>
              </form>
            <% } else { %>
              <div class="alert alert-warning mt-3">
                <i class="fa-solid fa-lock"></i>
                You must <a href="/login" class="fw-bold text-danger text-decoration-none">log in</a> to leave a review.
              </div>
            <% } %>

            <!-- üìú Display Reviews -->
            <% if (listing.reviews && listing.reviews.length > 0) { %>
              <div class="reviews-list">
                <h3 class="mb-4 text-dark">What others say:</h3>
                <% listing.reviews.forEach(review => { %>
                  <div class="review-card border rounded-3 p-3 mb-3 bg-light">
                    <p class="mb-1">
                      <strong><%= review.author?.username || "Anonymous" %></strong> ‚Äî
                      <% for (let i = 0; i < review.rating; i++) { %>‚≠ê<% } %>
                    </p>
                    <p class="mb-1"><%= review.comment %></p>
                    <small class="text-muted"><%= review.createdAt.toDateString() %></small>
                  </div>
                <% }) %>
              </div>
            <% } else { %>
              <p class="no-reviews text-muted">No reviews yet. Be the first to share your experience!</p>
            <% } %>
          </div>

          <!-- üó∫Ô∏è Map -->
          <div id="map" style="height: 400px; border-radius: 10px; margin-bottom: 30px;"></div>
        </div>
      </div>
    </div>

    <!-- üí≥ Right Column: Booking Box -->
    <div class="col-lg-4">
      <div class="booking-box shadow-sm rounded-4 p-4 bg-white">
        <h4>‚Çπ<%= listing.price.toLocaleString("en-IN") %> <span class="text-muted">/ night</span></h4>

        <!-- ‚úÖ AJAX Booking Form -->
        <form id="bookingForm" action="/bookings" method="POST" class="booking-form mt-3">
          <input type="hidden" name="listingId" value="<%= listing._id %>">
          <div class="mb-3">
            <label class="form-label">Check-in</label>
            <input type="date" name="checkIn" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Check-out</label>
            <input type="date" name="checkOut" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Guests</label>
            <input type="number" name="guests" class="form-control" min="1" max="10" required>
          </div>
          <button type="submit" class="btn btn-danger w-100 rounded-pill mt-2">
            <i class="bi bi-calendar-check me-1"></i> Book Now
          </button>
        </form>
      </div>
    </div>

  </div>
</section>

<!-- üí≥ Booking Confirmation Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4 rounded-4 border-0 shadow-lg">
      <div class="text-center">
        <i class="fa-solid fa-circle-check text-success" style="font-size: 3rem;"></i>
        <h4 class="fw-bold mt-3 text-success">Booking Confirmed!</h4>
        <p class="text-muted" id="modalListingInfo"></p>

        <div class="mt-3 border-top pt-3">
          <p class="mb-1"><strong>Check-in:</strong> <span id="modalCheckIn"></span></p>
          <p class="mb-1"><strong>Check-out:</strong> <span id="modalCheckOut"></span></p>
          <p class="mb-1"><strong>Guests:</strong> <span id="modalGuests"></span></p>
          <p class="fw-bold text-danger mt-3">‚Çπ<span id="modalPrice"></span> / night</p>
        </div>

        <div class="mt-3 border-top pt-3 text-start px-3">
          <p class="mb-1 d-flex justify-content-between"><span>Subtotal:</span> <span>‚Çπ<span id="modalSubtotal"></span></span></p>
          <p class="mb-1 d-flex justify-content-between"><span>Service Fee:</span> <span>‚Çπ<span id="modalServiceFee"></span></span></p>
          <hr>
          <p class="fw-bold d-flex justify-content-between"><span>Total:</span> <span>‚Çπ<span id="modalTotal"></span></span></p>
        </div>

        <div class="mt-4">
          <p class="text-muted small">Redirecting to your booking confirmation...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- üó∫Ô∏è Map + Booking JS -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const coords = <%- JSON.stringify(listing.geometry?.coordinates || null) %>;
  if (!coords || coords.length < 2) {
    console.error("No valid coordinates found for this listing!");
    return;
  }

  const map = L.map("map").setView([coords[1], coords[0]], 12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors"
  }).addTo(map);

  L.marker([coords[1], coords[0]])
    .addTo(map)
    .bindPopup(`<h5><%= listing.title %></h5><p><%= listing.location %></p>`)
    .openPopup();
});

// üí≥ Booking Modal Logic
document.addEventListener("DOMContentLoaded", () => {
  const bookingForm = document.getElementById("bookingForm");

  bookingForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(bookingForm);

    const response = await fetch("/bookings", {
      method: "POST",
      body: formData,
      headers: { "Accept": "application/json" } // ‚úÖ important fix
    });

    const result = await response.json();
    console.log("Booking response:", result);

    if (result.success) {
      const checkIn = new Date(result.checkIn);
      const checkOut = new Date(result.checkOut);
      const nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));
      const subtotal = nights * result.listing.price;
      const serviceFee = Math.round(subtotal * 0.08);
      const total = subtotal + serviceFee;

      document.getElementById("modalListingInfo").textContent = `${result.listing.title}, ${result.listing.location}`;
      document.getElementById("modalCheckIn").textContent = checkIn.toDateString();
      document.getElementById("modalCheckOut").textContent = checkOut.toDateString();
      document.getElementById("modalGuests").textContent = result.guests;
      document.getElementById("modalPrice").textContent = result.listing.price.toLocaleString("en-IN");
      document.getElementById("modalSubtotal").textContent = subtotal.toLocaleString("en-IN");
      document.getElementById("modalServiceFee").textContent = serviceFee.toLocaleString("en-IN");
      document.getElementById("modalTotal").textContent = total.toLocaleString("en-IN");

      const modal = new bootstrap.Modal(document.getElementById("bookingModal"));
      modal.show();

      setTimeout(() => {
        window.location.href = `/bookings/confirmation/${result.bookingId}`;
      }, 3000);
    } else {
      alert(result.error || "Booking failed. Please try again.");
    }
  });
});
</script>
